<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=UTF-8">
		<link rel="stylesheet" type="text/css" href="ext2.1/resources/css/ext-all.css" />
		<link rel="stylesheet" href="css/style.css" type="text/css" />
		<link rel="stylesheet" href="css/openlayers.css" type="text/css" />
		<script type="text/javascript" src="ext2.1/adapter/ext/ext-base.js"></script>
		<script type="text/javascript" src="ext2.1/ext-all.js"></script>
		<script type="text/javascript" src="ext2.1/ext-all-debug.js"></script>
		<script type="text/javascript" src="js/OpenLayers.js"></script>
		<script type="text/javascript" src="js/openlayer_extend.js"></script>
<script type="text/javascript" >

			var map;
			var wfs_readerinfo;
			var tower;
			var markLayer;
			var vectorLayer;
            var tiled;
            var ll, popupClass, popupContentHTML;
            var bounds = new OpenLayers.Bounds(
                    -127.61950064999999, 23.7351786,
                    -64.08177035, 50.592523400000005
            );
            var readerCoo=new Array();//基站坐标
            var pi=0;
            var geoPointArray=[]; //x,y坐标
			
			
			function updateFormats() {
            var in_options = {
                'internalProjection': map.baseLayer.projection,
                'externalProjection': new OpenLayers.Projection('EPSG:4326')
            };   
            var out_options = {
                'internalProjection': map.baseLayer.projection,
                'externalProjection': new OpenLayers.Projection('EPSG:4326')
            };           
            formats = {
              'in': {
                geojson: new OpenLayers.Format.GeoJSON(in_options)
              }, 
              'out': {
                geojson: new OpenLayers.Format.GeoJSON(out_options)
              } 
            };
        }
        
        var DeleteFeature = OpenLayers.Class(OpenLayers.Control, {
            initialize: function(layer, options) {
                OpenLayers.Control.prototype.initialize.apply(this, [options]);
                this.layer = layer;
                this.handler = new OpenLayers.Handler.Feature(
                    this, layer, {click: this.clickFeature}
                );
            },
            clickFeature: function(feature) {
                // if feature doesn't have a fid, destroy it
                if(feature.fid == undefined) {
                    this.layer.destroyFeatures([feature]);
                } else {
                    feature.state = OpenLayers.State.DELETE;
                    this.layer.events.triggerEvent("afterfeaturemodified", 
                                                   {feature: feature});
                    feature.renderIntent = "select";
                    this.layer.drawFeature(feature);
                }
            },
            setMap: function(map) {
                this.handler.setMap(map);
                OpenLayers.Control.prototype.setMap.apply(this, arguments);
            },
            CLASS_NAME: "OpenLayers.Control.DeleteFeature"
        });
			
			//disable the autosize for the purpose of our matrix
	        OpenLayers.Popup.FramedCloud.prototype.autoSize = false;
	
	        AutoSizeFramedCloud = OpenLayers.Class(OpenLayers.Popup.FramedCloud, {
	            'autoSize': true,
	            'maxSize': new OpenLayers.Size(300,300)
	        });
  Ext.onReady(function(){
  
	  Ext.form.Field.prototype.msgTarget = 'side'; 
	  var queryWindow; 
	  var readerinfoAddWin; 
	  var readerinfoEditWin; 
	  var readerinfoIDWin; 
	  
	  //创建地图对象
             var options = {
                 controls: [],
                 maxExtent: bounds, //layer能显示出的最大范围
                 maxResolution: 0.248194258984375, //layer能够显示的最大解析度
                 projection: "EPSG:4326",
                 units: 'degrees', //layer显示的单位，作用于比例尺-解析度换算
                 numZoomLevels: 6 //缩放级别的总数
             };
             map = new OpenLayers.Map('map1',options);                
             
             //创建图层 http://192.168.1.68:8080/geoserver/wms
             tiled = new OpenLayers.Layer.Image(
                 '基础地图图层',
              'img/xinjiang.png',
              new OpenLayers.Bounds(-194.27659,-79.83746,129.15492,83.80654),
              new OpenLayers.Size(880,620)
             );         
             map.addLayers([tiled]);
             
             var styles = new OpenLayers.StyleMap({
                "default": new OpenLayers.Style(null, {
                    rules: [
                        new OpenLayers.Rule({
                            symbolizer: {
                                "Point": {
                                    strokeColor: "#000000",
				                    strokeOpacity: 1,
				                    strokeWidth: 1,
				                    fillColor: "#000000",
				                    fillOpacity: 0.5,
				                    pointRadius: 6,
				                    graphicName:"star",
				                    pointerEvents: "visiblePainted"
                                }
                            }
                        })
                    ]
                }),
                "select": new OpenLayers.Style({
                    strokeColor: "#00ccff",
                    strokeWidth: 4
                }),
                "temporary": new OpenLayers.Style(null, {
                    rules: [
                        new OpenLayers.Rule({
                            symbolizer: {
                                "Point": {
                                	strokeColor: "#000000",
				                    strokeOpacity: 1,
				                    strokeWidth: 1,
				                    fillColor: "white",
				                    fillOpacity: 0.25,
				                    pointRadius: 6,
				                    graphicName:"star",
				                    pointerEvents: "visiblePainted"
                                }
                            }
                        })
                    ]
                })
            });
             
            wfs_readerinfo = new OpenLayers.Layer.Vector("用户编辑图层", {
               // strategies: [new OpenLayers.Strategy.BBOX(), saveStrategy],
                strategies: [new OpenLayers.Strategy.BBOX()],
                projection: new OpenLayers.Projection("EPSG:4326"),
                styleMap: styles
            });
			var options_s = {
                click: true
            };
            var select = new OpenLayers.Control.SelectFeature(wfs_readerinfo, options_s);
            map.addControl(select);
            select.activate();           
			updateFormats();

            // add some editing tools to a panel
            var panel = new OpenLayers.Control.Panel(
                {displayClass: 'customEditingToolbar'}
            );
            var draw = new OpenLayers.Control.DrawFeature(
                wfs_readerinfo, OpenLayers.Handler.Point,
                {
                    title: "增加",
                    displayClass: "olControlDrawFeaturePoint",                    
                    handlerOptions: {multi: true},
                    featureAdded:showReaderinfoAddWin
                }
            );
            var del = new DeleteFeature(wfs_readerinfo, {title: "删除"});
            panel.addControls([
                new OpenLayers.Control.Navigation({title:'选择'}),
                del, draw
            ]);
            
            panel.defaultControl = panel.controls[0];
            map.addControl(panel);

             //伸缩控件       
             map.addControl(new OpenLayers.Control.PanZoomBar({
                 position: new OpenLayers.Pixel(2, 15)
             }));
             map.addControl(new OpenLayers.Control.Navigation());
             //坐标
             map.addControl(new OpenLayers.Control.MousePosition());
             map.addControl(new OpenLayers.Control.LayerSwitcher());
             map.zoomToExtent(bounds);
             map.setCenter(new OpenLayers.LonLat(-36.88365,-1.70506),0);
             map.addLayer(wfs_readerinfo);
          /*创建一个Vector的容器图层
         	 vectorLayer = new OpenLayers.Layer.Vector(); 
         	 vectorLayer.style ={
        	 strokeColor: "#292421",
        	 strokeOpacity: 0.7,
        	 strokeWidth: 2
   		 };
        		map.addLayer(vectorLayer);
         	*/
         
            //创建一个marker容器图层
		markLayer = new OpenLayers.Layer.Markers("Markers");
          map.addLayer(markLayer);  
          
           //创建一个移动图标容器图层
		animationLayer = new OpenLayers.Layer.Markers("animationLayer");
		map.addLayer(animationLayer);
	
	////////////////////////////////////////////////////////////////
	 
  
 

  //--------------------------------------------------------------------------------------增加
  
   var readerinfoAddForm = new Ext.FormPanel({
    	labelAlign:'right',
        buttonAlign:'right',
        frame:true,
        items:[{
                layout:'column',
                items:[
	                    {
		            		columnWidth:1,
		            		layout:'form',
		            		labelWidth:70,
		            		items:
		            		[{
		           				fieldLabel:'基站ID',
								name:'readerid',
								xtype:'numberfield',
								allowBlank:false,
								minValue: 1,
								maxValue: 2048,
								maxLength: 4,
								blankText:'请输入基站号',
						        anchor:'92%'
		            		 }]
	            	     },
	            	     {
		            		columnWidth:1,
		            		layout:'form',
		            		labelWidth:70,
		            		items:
		            		[{
		           				fieldLabel:'基站X坐标',
								xtype: 'numberfield',
								name:'x',
								allowBlank:false,
								blankText:'基站X坐标不能为空',
								value: '0',
						        anchor:'92%'
		            		 }]
	            	     },
	            	     {
		            		columnWidth:1,
		            		layout:'form',
		            		labelWidth:70,
		            		items:
		            		[{
		           				fieldLabel:'基站Y坐标',
								xtype: 'numberfield',
								name:'y',
								allowBlank:false,
								blankText:'基站Y坐标不能为空',
								value: '0',
						        anchor:'92%'
		            		 }]
	            	     },
	            	     {
		            		columnWidth:1,
		            		layout:'form',
		            		labelWidth:70,
		            		items:
		            		[{
		           				fieldLabel:'备注信息',
								xtype: 'textfield',
								name:'otherinfo',
						        anchor:'92%'
		            		 }]
	            	     }
                ] 
        }], 
        buttons:[{
	        text:'保存',
	        type: 'submit',
	        handler:function(){
	              if(readerinfoAddForm.getForm().isValid()){
	        		  readerinfoAddForm.getForm().submit({ 
	        		       	 url: 'readerinfo.do?method=add',
	        		       	 method: 'post',
	        		       	 waitMsg: '保存中，请稍后...',
	        		         success:function(form,option){//提交成功的回调函数
	        		               if (option.result.message=='insert_readerinfo') {
								         Ext.Msg.alert('信息提示','新增基站成功');
								         readerinfoAddWin.hide();
								         store.reload(); //重新加载数据源
							       }else {
								         Ext.Msg.alert('信息提示',option.result.message);
							       }
		        		         },
						     failure:function(){ //提交失败的回调函数
									     Ext.Msg.alert("信息提示", " 连接服务器出现错误,请稍后再试！");
								}
	        		       }); }
	        }
	    },{
	    	text:'清空',
	    	handler:function(){
	    		readerinfoAddForm.getForm().reset();//表单清空
	     } 
	    },{
	    	 text: '关闭',
             handler: function(){
                 readerinfoAddWin.hide();
             }
	    }]
    });  

   function showReaderinfoAddWin(feature){
   		
   		var reader = formats['out']['geojson'].write(feature, false);
   		reader=eval("(" + reader + ")");

   		if(!readerinfoAddWin){
			readerinfoAddWin = new Ext.Window({
			    title:'编辑基站信息->增加',
			    width: 350,
		        height:210,
		        layout: 'fit',
		        bodyStyle:'padding:5px;',
			    draggable: false,//是否启动拖动效果
			    closable:true,//关闭按钮
			    closeAction:'hide',
		        plain:true,
		        modal:true,//父页面不可编辑
		        resizable:false,//false不可拖动边框的大小
			    items: [readerinfoAddForm]
			});
	    }
		readerinfoAddWin.show();
	    readerinfoAddForm.getForm().findField('x').setValue(reader.geometry.coordinates[0][0]);
   		readerinfoAddForm.getForm().findField('y').setValue(reader.geometry.coordinates[0][1]);
   		if(wfs_readerinfo.features.length==2){
   			wfs_readerinfo.destroyFeatures(wfs_readerinfo.features[0]);
   		}
     }  

	//initTower();
	
});

		//在地图上显示基站坐标
        function markTower(){
        	tower = new OpenLayers.Layer.Vector("基站坐标图层", {
        		//下面是基站的样式
                styleMap: new OpenLayers.StyleMap({'default':{
                    //strokeColor: "#000000",
                    //strokeOpacity: 1,
                    //strokeWidth: 1,
                    //fillColor: "#000000",
                    //fillOpacity: 0.5,
                    //pointRadius: 6,
                    //graphicName:"star",
                    //pointerEvents: "visiblePainted",
                    pointRadius: 12,//图片大小
                    externalGraphic: "js/img/reader.bmp",//图片位置
                    label : "ID: ${id}",//图片说明
                    fontColor: "#000000",//文字颜色
                    fontSize: "10px",//文字大小
                    labelAlign:"lb"//文字位置
                }})
                }
        	);
        	map.addLayer(tower);
        	
			for(var i=0;i<readerCoo.length;i++){				
	            var point = new OpenLayers.Geometry.Point(readerCoo[i][0], readerCoo[i][1]);
	            var pointFeature = new OpenLayers.Feature.Vector(point);
	            pointFeature.attributes = {
	                id: readerCoo[i][2]
	            };
	            tower.addFeatures([pointFeature]);
            }
        }

        
        
        //删除标记
		   function deleteMarkers() {
	           var i=0;
	           var myMarkers = markLayer.markers;
	           while (i<myMarkers.length) {
		       		markLayer.removeMarker(myMarkers[i]);   
	           }
           }
		   
         //删除移动标记
           function deleteAnimationMarks() {
	           var i=0;
	           var myMarkers = animationLayer.markers;
	           while (i<myMarkers.length) {
		       		animationLayer.removeMarker(myMarkers[i]);   
	           } 
           } 
           
           /**
			* 目标定位
			*/
			function showLocation(locationGrid){
				 //删除标记
		         //deleteAnimationMarks();
		         deleteMarkers(); 
				 //停止定位跟踪
		         //stopLocationTask();
		         //显示位置和标记信息  
		         markerDetailInfo(locationGrid); 
			}
			
		/**
		 *grid 中属性的名字必须一致
		 */
		 function markerDetailInfo(grid){
       		 var record = grid.getSelectionModel().getSelected();
			 var rx =record.data.x;
			 var ry =record.data.y;
			
		    	ll = new OpenLayers.LonLat(rx,ry);
            	popupClass = AutoSizeFramedCloud;
            	popupContentHTML ='基站号：    '+record.data.readerid+'<br />'
            	                 +'基站名：    '+record.data.readername+'<br />'
            	                 +'接收卡数：'+record.data.cardnum+'<br />'
            	                 +'通讯时间：'+record.data.lasttime+'<br />'
            	                 +'报警信息：'+record.data.information+'<br />';
            	                
            	addMarker(ll, popupClass, popupContentHTML, true, true);  
                
	    	    var center = new OpenLayers.LonLat(rx,ry);
			    map.panTo(center);		
			   	          
			//}	
       }
       
       /**
		 * 
		 * @param {} ll
		 * @param {} popupClass
		 * @param {} popupContentHTML
		 * @param {} closeBox 是否有关闭按钮(图片)
		 * @param {} overflow 是否有滚动条
		 * 
		 * 添加标记，并显示详细信息
		 */
		function addMarker(ll, popupClass, popupContentHTML, closeBox, overflow) {
			
		    var feature = new OpenLayers.Feature(markLayer, ll); 
		    feature.closeBox = closeBox;
		    feature.popupClass = popupClass;
		    feature.data.popupContentHTML = popupContentHTML;
		    feature.data.overflow = (overflow) ? "auto" : "hidden";
		            
		    var marker = feature.createMarker();
		    marker.setUrl('img/mark1.gif');
		    marker.display(true); 
		    
		    var markerClick = function (evt) {
		        if (this.popup == null) {
		            this.popup = this.createPopup(this.closeBox);
		            map.addPopup(this.popup);
		            this.popup.show();
		        } else {
		            this.popup.toggle();
		        }
		        currentPopup = this.popup;
		        OpenLayers.Event.stop(evt);
		    };
		    marker.events.register("mousedown", feature, markerClick);
		    markLayer.addMarker(marker);
		}
</script> 
</head>

	<body>
		
		<div id="map1" style="width:100%;float:left;height:100%;"></div>
		
				  
	</body>

</html>
